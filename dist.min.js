const c=document.getElementById("c"),ctx=c.getContext("2d");c.width=800,c.height=400;let zzfxV=.3,zzfxX=new AudioContext,zzfx=(e=1,t=.05,a=220,c=0,n=0,l=.1,o=0,i=1,r=0,y=0,x=0,s=0,f=0,p=0,h=0,d=0,w=0,u=1,g=0,m=0,v=0)=>{let k=Math,S=2*k.PI,b=44100,M=r*=500*S/b/b,R=a*=(1-t+2*t*k.random(t=[]))*S/b,I=0,P=0,C=0,X=1,Q=0,T=0,A=0,z=v<0?-1:1,D=S*z*v*2/b,H=k.cos(D),B=k.sin,E=B(D)/4,O=1+E,L=-2*H/O,G=(1-E)/O,Y=(1+z*H)/2/O,j=-(z+H)/O,U=Y,$=0,N=0,V=0,F=0;for(y*=500*S/b**3,h*=S/b,x*=S/b,s*=b,f=b*f|0,e*=zzfxV,z=(c=b*c+9)+(g*=b)+(n*=b)+(l*=b)+(w*=b)|0;C<z;t[C++]=A*e)++T%(100*d|0)||(A=o?1<o?2<o?3<o?B(I**3):k.max(k.min(k.tan(I),1),-1):1-(2*I/S%2+2)%2:1-4*k.abs(k.round(I/S)-I/S):B(I),A=(f?1-m+m*B(S*C/f):1)*(A<0?-1:1)*k.abs(A)**i*(C<c?C/c:C<c+g?1-(C-c)/g*(1-u):C<c+g+n?u:C<z-w?(z-C-w)/l*u:0),A=w?A/2+(w>C?0:(C<z-w?1:(z-C)/w)*t[C-w|0]/2/e):A,v&&(A=F=U*$+j*($=N)+Y*(N=A)-G*V-L*(V=F))),D=(a+=r+=y)*k.cos(h*P++),I+=D+D*p*B(C**5),X&&++X>s&&(a+=x,R+=x,X=0),!f||++Q%f||(a=R,r=M,X=X||1);(e=zzfxX.createBuffer(1,z,b)).getChannelData(0).set(t),(a=zzfxX.createBufferSource()).buffer=e,a.connect(zzfxX.destination),a.start()},day=!0,timer=15e3,dayLength=3e4,nightLength=3e4,gravity=.3,camX=0,gameState="playing";const maxDistance=5e3;let craftingOpen=!1,craftingRecipes=[{name:"Axe",cost:{wood:3,stone:0},time:3},{name:"Pick Axe",cost:{wood:5,stone:0},time:5},{name:"Trap",cost:{wood:2,stone:0},time:5},{name:"Axe +1",cost:{wood:10,stone:1},time:1},{name:"Pick Axe +1",cost:{wood:4,stone:4},time:10},{name:"Bridge",cost:{wood:5,stone:0},time:2},{name:"Axe +2",cost:{wood:20,stone:5},time:6},{name:"Pick Axe +2",cost:{wood:3,stone:3},time:8},{name:"Trap +2",cost:{wood:8,stone:0},time:2}],craftingQueue=null,player={x:200,y:300,w:20,h:20,vy:0,onGround:!1};woodDamage=1,stoneDamage=1;const speed=3;let interactCooldown=0,musicStarted=!1;function playDayMusic(){window.nightMusicInterval&&(clearInterval(window.nightMusicInterval),window.nightMusicInterval=null),window.dayMusicInterval&&(clearInterval(window.dayMusicInterval),window.dayMusicInterval=null),window.dayMusicInterval=setInterval(()=>{zzfx(.3,0,440,.05,.15,.1,0,0,0,0,0,0,0,.5),zzfx(.3,0,660,.05,.15,.1,0,0,0,0,0,0,0,.5)},800)}function playNightMusic(){window.dayMusicInterval&&(clearInterval(window.dayMusicInterval),window.dayMusicInterval=null),window.nightMusicInterval&&(clearInterval(window.nightMusicInterval),window.nightMusicInterval=null),window.nightMusicInterval=setInterval(()=>{zzfx(...[1,,220,,.5,.5,1,,0,,0,,0,.5])},1200)}const inventorySize=8;let craftingMessage=null,inventory={wood:0,stone:0};function addToInventory(e,t){e in inventory||(inventory[e]=0),inventory[e]+=t}function hasResources(e){const t=e.cost||{};return!(t.wood&&inventory.wood<t.wood)&&!(t.stone&&inventory.stone<t.stone)}function spendResources(e){const t=e.cost||{};t.wood&&(inventory.wood-=t.wood),t.stone&&(inventory.stone-=t.stone)}function refundResources(e){const t=e.cost||{};t.wood&&(inventory.wood=(inventory.wood||0)+t.wood),t.stone&&(inventory.stone=(inventory.stone||0)+t.stone)}let catHeight=c.height/4,cat={x:0,y:250,w:catHeight,h:catHeight,speed:2,vy:0},blinking=!1,blinkCooldown=1e3+2e3*Math.random(),blinkDuration=0,lastTime=0,signs=[{x:400,y:180,text:"Press A/D to move"},{x:1150,y:180,text:"Press W to jump"},{x:4e3,y:180,text:"Press SPACE to break the stone"},{x:5e3,y:180,text:"Press C to craft a bridge"}],blocks=[{x:0,y:350,w:5e3,h:50},{x:5150,y:350,w:5e3,h:50},{x:1e3,y:280,w:100,h:20},{x:1150,y:240,w:100,h:20},{x:1300,y:200,w:100,h:20},{x:1450,y:160,w:100,h:20},{x:1600,y:140,w:100,h:1e3},{x:1800,y:0,w:20,h:300},{x:1800,y:280,w:750,h:20},{x:1900,y:210,w:750,h:20},{x:1800,y:140,w:750,h:20},{x:1900,y:70,w:750,h:20},{x:1800,y:0,w:750,h:20},{x:2600,y:70,w:100,h:1e3}],stones=[{x:4e3,y:200,w:100,h:150,hp:30}],trees=[{x:3020,y:290,w:22,h:60,hp:10,maxHp:10},{x:3075,y:290,w:22,h:60,hp:10,maxHp:10},{x:3200,y:290,w:22,h:60,hp:10,maxHp:10},{x:3500,y:290,w:22,h:60,hp:10,maxHp:10},{x:3600,y:290,w:22,h:60,hp:10,maxHp:10},{x:3700,y:290,w:22,h:60,hp:10,maxHp:10},{x:3810,y:290,w:22,h:60,hp:10,maxHp:10},{x:4020,y:290,w:22,h:60,hp:10,maxHp:10},{x:4075,y:290,w:22,h:60,hp:10,maxHp:10},{x:4200,y:290,w:22,h:60,hp:10,maxHp:10},{x:4500,y:290,w:22,h:60,hp:10,maxHp:10},{x:4600,y:290,w:22,h:60,hp:10,maxHp:10},{x:4700,y:290,w:22,h:60,hp:10,maxHp:10},{x:4810,y:290,w:22,h:60,hp:10,maxHp:10}],traps=[],keys={};onkeydown=e=>keys[e.key]=!0,onkeyup=e=>keys[e.key]=!1,document.addEventListener("keydown",e=>{day&&"f"===e.key&&traps.push({x:player.x,y:c.height-60,w:15,h:15,active:!0})}),document.addEventListener("keydown",e=>{"KeyC"===e.code&&(craftingOpen=!craftingOpen)}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(craftingQueue?(refundResources(craftingQueue.recipe),craftingQueue=null):craftingOpen&&(craftingOpen=!1))});let mouse={x:0,y:0};c.addEventListener("mousemove",e=>{const t=c.getBoundingClientRect();mouse.x=e.clientX-t.left,mouse.y=e.clientY-t.top}),c.addEventListener("mousedown",e=>{if(!craftingOpen)return;const t=c.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,l=50,o=(c.width-186)/2+10,i=(c.height-186)/2+10;craftingRecipes.forEach((e,t)=>{const c=t%3,r=Math.floor(t/3),y=o+58*c,x=i+58*r;a>y&&a<y+l&&n>x&&n<x+l&&(craftingQueue||(hasResources(e)?(console.log("has resources:",hasResources(e)),console.log("Klick p!!Ã¥:",e.name),spendResources(e),craftingQueue={recipe:e,timeLeft:e.time},craftingOpen=!1):(craftingMessage="Not enough resources!",setTimeout(()=>craftingMessage=null,2e3))))})}),c.addEventListener("mousemove",e=>{const t=c.getBoundingClientRect();mouse.x=e.clientX-t.left,mouse.y=e.clientY-t.top});const eyeR=60,pupilR=18,eyeOffsetX=130,eyeY=c.height/2;function drawEye(e,t){ctx.save(),ctx.shadowColor="rgba(255, 230, 80, 0.9)",ctx.shadowBlur=25,ctx.fillStyle="rgb(255, 220, 60)",ctx.beginPath(),ctx.arc(e,t,60,0,2*Math.PI),ctx.fill(),ctx.restore();const a=mouse.x-e,c=mouse.y-t,n=Math.hypot(a,c)||1,l=e+a/n*Math.min(n,36),o=t+c/n*Math.min(n,36);ctx.fillStyle="#000",ctx.beginPath(),ctx.arc(l,o,18,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgba(255,255,255,0.7)",ctx.beginPath(),ctx.arc(l-7.2,o-7.2,3,0,2*Math.PI),ctx.fill()}function drawStartMenu(){ctx.fillStyle="#000",ctx.fillRect(0,0,c.width,c.height);const e=c.width/2;drawEye(e-130,eyeY),drawEye(e+130,eyeY),ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle="red",ctx.font="36px monospace",ctx.shadowColor="rgba(255,0,0,0.35)",ctx.shadowBlur=10,ctx.fillText("Run from the black cat",c.width/2,eyeY-60-50),ctx.font="18px monospace",ctx.textAlign="left",ctx.textBaseline="bottom",ctx.shadowBlur=0;const t="Click to Start",a=ctx.measureText(t).width,n=c.height-20,l=mouse.x>=620&&mouse.x<=620+a&&mouse.y>=n-24&&mouse.y<=n;ctx.fillStyle=l?"yellow":"white",ctx.fillText(t,620,n),c.addEventListener("click",e=>{if("startMenu"===gameState){e.offsetX,e.offsetY;l&&("suspended"===zzfxX.state&&zzfxX.resume(),playDayMusic(),gameState="playing")}})}function drawSigns(){ctx.font="16px monospace",ctx.textAlign="center",ctx.textBaseline="bottom";for(let e of signs)ctx.fillStyle="white",ctx.fillText(e.text,e.x-camX,e.y-10)}function drawDebug(){ctx.font="12px monospace",ctx.fillStyle="lime",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText(`x: ${Math.floor(player.x)} y: ${Math.floor(player.y)}`,10,10)}function drawCrafting(){if(!craftingOpen)return;const e=50,t=(c.width-186)/2,a=(c.height-186)/2;ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(t,a,186,186),ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="12px Arial",craftingRecipes.forEach((c,n)=>{const l=n%3,o=Math.floor(n/3),i=t+10+58*l,r=a+10+58*o;ctx.fillStyle="rgba(60,60,60,0.9)",ctx.fillRect(i,r,e,e),ctx.strokeStyle="#fff",ctx.strokeRect(i,r,e,e),ctx.fillStyle="#fff",ctx.fillText(c.name,i+25,r+25)});const n=mouse.x,l=mouse.y;craftingRecipes.forEach((c,o)=>{const i=o%3,r=Math.floor(o/3),y=t+10+58*i,x=a+10+58*r;if(n>y&&n<y+e&&l>x&&l<x+e){const e=Object.entries(c.cost).filter(([e,t])=>t>0).map(([e,t])=>`${t} ${e}`).join(", "),t=e+(e?", ":"")+`${c.time}s`,a=ctx.measureText(t).width+10,o=20;ctx.fillStyle="rgba(0,0,0,0.8)",ctx.fillRect(n+10,l+10,a,o),ctx.fillStyle="#fff",ctx.fillText(t,n+10+a/2,l+10+o/2)}})}function drawCraftingProgress(){if(craftingQueue){const e=200,t=20,a=(c.width-e)/2,n=c.height-60;ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fillRect(a,n,e,t),ctx.fillStyle="lime";const l=1-craftingQueue.timeLeft/craftingQueue.recipe.time;ctx.fillRect(a,n,e*l,t)}if(craftingQueue){const e=200,t=20,a=(c.width-e)/2,n=c.height-60,l=(craftingQueue.recipe.time-craftingQueue.timeLeft)/craftingQueue.recipe.time;ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(a,n,e,t),ctx.fillStyle="lime",ctx.fillRect(a,n,e*l,t),ctx.strokeStyle="#fff",ctx.strokeRect(a,n,e,t),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.fillText(craftingQueue.recipe.name+" ("+craftingQueue.recipe.time+"s)",a+e/2,n-5)}}function drawTraps(){for(let e of traps)e.active&&(ctx.fillStyle="orange",ctx.fillRect(e.x-camX,e.y,e.w,e.h))}function drawInventory(){if(Object.values(inventory).every(e=>0===e))return;const e=40,t=Object.keys(inventory).filter(e=>inventory[e]>0),a=46*t.length-6,n=(c.width-a)/2,l=c.height-e-10;ctx.font="14px Arial",ctx.textAlign="right",ctx.textBaseline="bottom",t.forEach((t,a)=>{const c=n+46*a;ctx.fillStyle="rgba(50,50,50,0.7)",ctx.fillRect(c,l,e,e),ctx.strokeStyle="#fff",ctx.strokeRect(c,l,e,e),"wood"===t?(ctx.fillStyle="#8B4513",ctx.fillRect(c+10,l+10,20,20)):"stone"===t&&(ctx.fillStyle="#777",ctx.fillRect(c+10,l+10,20,20)),ctx.fillStyle="#fff",ctx.fillText(inventory[t],c+e-3,l+e-3)})}function drawTrees(){for(const e of trees){ctx.fillStyle=day?"#5e2b08ff":"#555",ctx.fillRect(e.x-camX,e.y,e.w,e.h);const t=e.x-camX+e.w/2,a=e.y-10;if(ctx.fillStyle=day?"#2e8b57":"#444",ctx.beginPath(),ctx.ellipse(t,a,1.4*e.w,18,0,0,2*Math.PI),ctx.fill(),e.hp<e.maxHp&&e.hp>0){const t=e.w,a=3,c=e.x-camX,n=e.y-6;ctx.fillStyle="#333",ctx.fillRect(c,n,t,a),ctx.fillStyle="#4caf50",ctx.fillRect(c,n,t*(e.hp/e.maxHp),a),ctx.strokeStyle="#000",ctx.strokeRect(c,n,t,a)}}}function drawCat(){if(!0===day)ctx.fillStyle="black",ctx.fillRect(cat.x-camX,cat.y,cat.w,cat.h),ctx.fillStyle="white",ctx.font="16px monospace",ctx.fillText("Zzz",cat.x-camX+20,cat.y-10);else if(ctx.fillStyle="black",ctx.fillRect(cat.x-camX,cat.y,cat.w,cat.h-10),!blinking){let e=cat.y+cat.h/2-20,t=cat.x-camX+.3*cat.w,a=cat.x-camX+.7*cat.w,c=.2*cat.h,n=.4*c;ctx.fillStyle="yellow",ctx.beginPath(),ctx.arc(t,e,c,0,2*Math.PI),ctx.arc(a,e,c,0,2*Math.PI),ctx.fill(),ctx.fillStyle="black",ctx.beginPath(),ctx.arc(t,e,n,0,2*Math.PI),ctx.arc(a,e,n,0,2*Math.PI),ctx.fill()}}function drawPlayer(){ctx.fillStyle="lime",ctx.fillRect(player.x-camX,player.y,player.w,player.h),craftingQueue&&(ctx.fillStyle="yellow",ctx.fillRect(player.x-camX,player.y-10,player.w,5))}function drawBackground(){ctx.fillStyle=day?"#88d":"#000",ctx.fillRect(0,0,c.width,c.height)}function drawPlattform(){ctx.fillStyle=day?"#8B4513":"#303030ff";for(let e of blocks)ctx.fillRect(e.x-camX,e.y,e.w,e.h);ctx.fillStyle="gray";for(let e of stones){e.maxHp||(e.maxHp=e.hp),ctx.fillRect(e.x-camX,e.y,e.w,e.h);const t=40,a=Math.max(0,e.hp/e.maxHp),c=e.x-camX+e.w/2-t/2,n=e.y-8;ctx.fillStyle="darkred",ctx.fillRect(c,n,t,4),ctx.fillStyle="red",ctx.fillRect(c,n,t*a,4),ctx.strokeStyle="black",ctx.strokeRect(c,n,t,4),ctx.fillStyle="gray"}}function drawUI(){ctx.fillStyle="white",ctx.font="14px monospace",ctx.fillText(day?"DAY":"NIGHT",10,20),ctx.fillText("Timer: "+Math.ceil(timer/1e3),10,40)}function drawGameOver(){ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(0,0,c.width,c.height),ctx.fillStyle="red",ctx.font="30px monospace",ctx.fillText("GAME OVER",c.width/2-80,c.height/2),ctx.fillStyle="white",ctx.font="16px monospace",ctx.fillText("Press F5 to restart",c.width/2-100,c.height/2+30)}function rectsOverlap(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y}function loop(){if(requestAnimationFrame(loop),"startMenu"===gameState&&drawStartMenu(),"gameOver"===gameState&&drawGameOver(),"playing"===gameState){timer-=16,timer<=0&&(day=!day,timer=day?dayLength:nightLength,day?playDayMusic():playNightMusic()),(player.y>c.height+200||player.x>c.width+camX+200)&&(gameState="gameOver"),interactCooldown>0&&(interactCooldown-=16);let e=0;craftingQueue||(keys.a&&(e-=3),keys.d&&(e+=3),keys.w&&player.onGround&&(player.vy=-7,player.onGround=!1));const t=blocks.concat(stones);player.vy+=gravity,player.y+=player.vy,player.onGround=!1;for(let e of blocks)player.x<e.x+e.w&&player.x+player.w>e.x&&player.y<e.y+e.h&&player.y+player.h>e.y&&(player.vy>0&&player.y+player.h>e.y&&player.y<e.y?(player.y=e.y-player.h,player.vy=0,player.onGround=!0):player.vy<0&&player.y<e.y+e.h&&player.y+player.h>e.y+e.h&&(player.y=e.y+e.h,player.vy=0));player.x+=e;for(const a of t)player.x<a.x+a.w&&player.x+player.w>a.x&&player.y<a.y+a.h&&player.y+player.h>a.y&&(e>0?player.x=a.x-player.w:e<0&&(player.x=a.x+a.w));player.vy+=gravity,player.y+=player.vy,player.onGround=!1;for(const e of t)player.x<e.x+e.w&&player.x+player.w>e.x&&player.y<e.y+e.h&&player.y+player.h>e.y&&(player.vy>0?(player.y=e.y-player.h,player.vy=0,player.onGround=!0):player.vy<0&&(player.y=e.y+e.h,player.vy=0));if(keys[" "]&&interactCooldown<=0){const e=12,t=()=>{interactCooldown=200};let a=!1;if(void 0!==stones){for(const t of stones)if(player.x+player.w>t.x-e&&player.x<t.x+t.w+e&&player.y+player.h>t.y-e&&player.y<t.y+t.h+e&&t.hp>0){t.hp=t.hp-stoneDamage,t.hitCooldown=10,a=!0,t.hp<=0&&(console.log("added to inventory"),addToInventory("stone",3));break}stones=stones.filter(e=>e.hp>0)}if(!a){for(const t of trees)if(player.x+player.w>t.x-e&&player.x<t.x+t.w+e&&player.y+player.h>t.y-e&&player.y<t.y+t.h+e&&t.hp>0){t.hp=t.hp-woodDamage,a=!0,t.hp<=0&&(console.log("added to inventory"),addToInventory("wood",1));break}trees=trees.filter(e=>e.hp>0)}a&&t(),keys[" "]=!1}for(let e of stones)e.hitCooldown&&e.hitCooldown--;if(stones=stones.filter(e=>e.hp>0),!1===day){for(let e of traps)e.active&&cat.x<e.x+e.w&&cat.x+cat.w>e.x&&cat.y<e.y+e.h&&cat.y+cat.h>e.y&&(e.active=!1,cat.stunnedUntil=Date.now()+3e3);if(void 0===cat.vx&&(cat.vx=0),!(cat.stunnedUntil&&Date.now()<cat.stunnedUntil)){const e=cat.x+cat.w/2,t=player.x+player.w/2;if(cat.onGround){e<t-5?cat.x+=cat.speed:e>t+5&&(cat.x-=cat.speed);const a=Math.abs(e-t),c=player.y-cat.y;a<150&&c<-50&&(cat.vy=-15,cat.vx=t>e?4:-4,cat.onGround=!1)}}cat.onGround||(cat.x+=cat.vx),cat.vy+=gravity,cat.y+=cat.vy;const e=c.height-50;cat.y+cat.h>=e&&(cat.y=e-cat.h,cat.vy=0,cat.vx=0,cat.onGround=!0),blinking?(blinkDuration-=30,blinkDuration<=0&&(blinking=!1,blinkCooldown=1500+2e3*Math.random())):(blinkCooldown-=10,blinkCooldown<=0&&(blinking=!0,blinkDuration=180)),player.x<cat.x+cat.w&&player.x+player.w>cat.x&&player.y<cat.y+cat.h&&player.y+player.h>cat.y&&(gameState="gameOver")}if(!0===day&&(blinking=!1,blinkDuration=0),camX=player.x-c.width/2,camX<0&&(camX=0),craftingQueue&&(craftingQueue.timeLeft-=1/60,craftingQueue.timeLeft<=0)){console.log("klar:",craftingQueue.recipe.name),"Axe"===craftingQueue.recipe.name&&(woodDamage=2),"Axe +1"===craftingQueue.recipe.name&&(woodDamage=3),"Axe +2"===craftingQueue.recipe.name&&(woodDamage=4),"Pick Axe"===craftingQueue.recipe.name&&(stoneDamage=2),"Pick Axe +1"===craftingQueue.recipe.name&&(stoneDamage=3),"Pick Axe +2"===craftingQueue.recipe.name&&(stoneDamage=4),"Bridge"===craftingQueue.recipe.name&&blocks.push({x:player.x+player.w+10,y:player.y+player.h-10,w:100,h:20});let e=craftingQueue.recipe.name.toLowerCase();inventory[e]=(inventory[e]||0)+1,craftingQueue=null}drawBackground(),drawPlattform(),drawTrees(),drawCat(),drawPlayer(),drawTraps(),drawUI(),drawInventory(),drawCrafting(),drawCraftingProgress(),drawSigns(),drawDebug(),craftingMessage&&(ctx.fillStyle="red",ctx.font="20px Arial",ctx.fillText(craftingMessage,c.width/2-80,c.height/2-100))}}loop();