const c=document.getElementById("c"),ctx=c.getContext("2d");c.width=800,c.height=400;let day=!0,timer=1e4,dayLength=1e4,nightLength=2e4,gravity=.3,camX=0,gameState="playing";const maxDistance=5e3;let craftingOpen=!1,craftingRecipes=[{name:"Trap",cost:{wood:3,stone:1},time:3},{name:"Wall",cost:{wood:5,stone:0},time:5},{name:"Bridge",cost:{wood:2,stone:2},time:4},{name:"Torch",cost:{wood:1,stone:0},time:1},{name:"Cat Repeller",cost:{wood:4,stone:4},time:10},{name:"Door",cost:{wood:2,stone:1},time:2},{name:"Chest",cost:{wood:6,stone:0},time:6},{name:"Tower",cost:{wood:3,stone:3},time:8},{name:"Spike Pit",cost:{wood:0,stone:5},time:7}],craftingQueue=null,player={x:200,y:300,w:20,h:20,vy:0,onGround:!1},interactCooldown=0;const inventorySize=8;let inventory=Array(8).fill(null);function addToInventory(t,e){for(let l=0;l<inventory.length;l++)if(inventory[l]&&inventory[l].type===t)return void(inventory[l].count+=e);for(let l=0;l<inventory.length;l++)if(null===inventory[l])return void(inventory[l]={type:t,count:e})}let catHeight=c.height/4,cat={x:0,y:250,w:catHeight,h:catHeight,speed:1,vy:0},blinking=!1,blinkCooldown=1e3+2e3*Math.random(),blinkDuration=0,lastTime=0,blocks=[{x:0,y:350,w:2e4,h:50},{x:300,y:300,w:100,h:20},{x:500,y:250,w:100,h:20},{x:800,y:300,w:150,h:20},{x:1200,y:300,w:100,h:20},{x:2200,y:250,w:50,h:20},{x:2200,y:250,w:150,h:20}],stones=[{x:800,y:250,w:100,h:100,hp:5},{x:1200,y:280,w:80,h:70,hp:5}],trees=[{x:600,y:290,w:22,h:60,hp:5,maxHp:5},{x:950,y:290,w:22,h:60,hp:5,maxHp:5},{x:1350,y:290,w:22,h:60,hp:5,maxHp:5}],traps=[],keys={};onkeydown=t=>keys[t.key]=!0,onkeyup=t=>keys[t.key]=!1,document.addEventListener("keydown",t=>{day&&"f"===t.key&&traps.push({x:player.x,y:c.height-60,w:15,h:15,active:!0})}),document.addEventListener("keydown",t=>{"KeyC"===t.code&&(craftingOpen=!craftingOpen)}),document.addEventListener("keydown",t=>{"Escape"===t.key&&(craftingQueue?craftingQueue=null:craftingOpen&&(craftingOpen=!1))});let mouse={x:0,y:0};function drawCrafting(){if(!craftingOpen)return;const t=50,e=(c.width-186)/2,l=(c.height-186)/2;ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(e,l,186,186),ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="12px Arial",craftingRecipes.forEach((c,a)=>{const i=a%3,n=Math.floor(a/3),r=e+10+58*i,o=l+10+58*n;ctx.fillStyle="rgba(60,60,60,0.9)",ctx.fillRect(r,o,t,t),ctx.strokeStyle="#fff",ctx.strokeRect(r,o,t,t),ctx.fillStyle="#fff",ctx.fillText(c.name,r+25,o+25)});const a=mouse.x,i=mouse.y;craftingRecipes.forEach((c,n)=>{const r=n%3,o=Math.floor(n/3),y=e+10+58*r,f=l+10+58*o;if(a>y&&a<y+t&&i>f&&i<f+t){const t=Object.entries(c.cost).filter(([t,e])=>e>0).map(([t,e])=>`${e} ${t}`).join(", "),e=t+(t?", ":"")+`${c.time}s`,l=ctx.measureText(e).width+10,n=20;ctx.fillStyle="rgba(0,0,0,0.8)",ctx.fillRect(a+10,i+10,l,n),ctx.fillStyle="#fff",ctx.fillText(e,a+10+l/2,i+10+n/2)}})}function drawCraftingProgress(){if(craftingQueue){const t=200,e=20,l=(c.width-t)/2,a=c.height-60;ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fillRect(l,a,t,e),ctx.fillStyle="lime";const i=1-craftingQueue.timeLeft/craftingQueue.recipe.time;ctx.fillRect(l,a,t*i,e)}if(craftingQueue){const t=200,e=20,l=(c.width-t)/2,a=c.height-60,i=(craftingQueue.recipe.time-craftingQueue.timeLeft)/craftingQueue.recipe.time;ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(l,a,t,e),ctx.fillStyle="lime",ctx.fillRect(l,a,t*i,e),ctx.strokeStyle="#fff",ctx.strokeRect(l,a,t,e),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.fillText(craftingQueue.recipe.name+" ("+craftingQueue.recipe.time+"s)",l+t/2,a-5)}}function drawTraps(){for(let t of traps)t.active&&(ctx.fillStyle="orange",ctx.fillRect(t.x-camX,t.y,t.w,t.h))}function drawInventory(){if(inventory.every(t=>null===t))return;const t=40,e=(c.width-362)/2,l=c.height-t-10;ctx.font="14px Arial",ctx.textAlign="right",ctx.textBaseline="bottom";for(let c=0;c<8;c++){const a=e+46*c;ctx.fillStyle="rgba(50,50,50,0.7)",ctx.fillRect(a,l,t,t),ctx.strokeStyle="#fff",ctx.strokeRect(a,l,t,t);const i=inventory[c];i&&("wood"===i.type?(ctx.fillStyle="#8B4513",ctx.fillRect(a+10,l+10,20,20)):"stone"===i.type&&(ctx.fillStyle="#777",ctx.fillRect(a+10,l+10,20,20)),ctx.fillStyle="#fff",ctx.fillText(i.count,a+t-3,l+t-3))}}function drawTrees(){for(const t of trees){ctx.fillStyle=day?"#8B4513":"#555",ctx.fillRect(t.x-camX,t.y,t.w,t.h);const e=t.x-camX+t.w/2,l=t.y-10;if(ctx.fillStyle=day?"#2e8b57":"#444",ctx.beginPath(),ctx.ellipse(e,l,1.4*t.w,18,0,0,2*Math.PI),ctx.fill(),t.hp<t.maxHp&&t.hp>0){const e=t.w,l=3,c=t.x-camX,a=t.y-6;ctx.fillStyle="#333",ctx.fillRect(c,a,e,l),ctx.fillStyle="#4caf50",ctx.fillRect(c,a,e*(t.hp/t.maxHp),l),ctx.strokeStyle="#000",ctx.strokeRect(c,a,e,l)}}}function drawCat(){if(!0===day)ctx.fillStyle="black",ctx.fillRect(cat.x-camX,cat.y,cat.w,cat.h),ctx.fillStyle="white",ctx.font="16px sans-serif",ctx.fillText("Zzz",cat.x-camX,cat.y-10);else if(ctx.fillStyle="black",ctx.fillRect(cat.x-camX,cat.y,cat.w,cat.h),!blinking){let t=cat.y+cat.h/2-20,e=cat.x-camX+.3*cat.w,l=cat.x-camX+.7*cat.w,c=.2*cat.h,a=.4*c;ctx.fillStyle="yellow",ctx.beginPath(),ctx.arc(e,t,c,0,2*Math.PI),ctx.arc(l,t,c,0,2*Math.PI),ctx.fill(),ctx.fillStyle="black",ctx.beginPath(),ctx.arc(e,t,a,0,2*Math.PI),ctx.arc(l,t,a,0,2*Math.PI),ctx.fill()}}function drawPlayer(){ctx.fillStyle="lime",ctx.fillRect(player.x-camX,player.y,player.w,player.h),craftingQueue&&(ctx.fillStyle="yellow",ctx.fillRect(player.x-camX,player.y-10,player.w,5))}function drawBackground(){ctx.fillStyle=day?"#88d":"#000",ctx.fillRect(0,0,c.width,c.height)}function drawPlattform(){ctx.fillStyle=day?"#8B4513":"#303030ff";for(let t of blocks)ctx.fillRect(t.x-camX,t.y,t.w,t.h);ctx.fillStyle="gray";for(let t of stones)ctx.fillRect(t.x-camX,t.y,t.w,t.h),ctx.fillStyle="red",ctx.fillRect(t.x-camX,t.y-5,t.w*(t.hp/5),3),ctx.fillStyle="gray"}function drawUI(){ctx.fillStyle="white",ctx.font="14px sans-serif",ctx.fillText(day?"DAY":"NIGHT",10,20),ctx.fillText("Timer: "+Math.ceil(timer/1e3),10,40);let t=Math.min(player.x/5e3,1),e=Math.min(cat.x/5e3,1);ctx.fillStyle="#333",ctx.fillRect(20,20,c.width-40,10),ctx.fillStyle="lime",ctx.fillRect(20,20,(c.width-40)*t,10),ctx.fillStyle="red",ctx.fillRect(20,20,(c.width-40)*e,10),ctx.strokeStyle="white",ctx.strokeRect(20,20,c.width-40,10)}function drawGameOver(){ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(0,0,c.width,c.height),ctx.fillStyle="red",ctx.font="30px sans-serif",ctx.fillText("GAME OVER",c.width/2-80,c.height/2),ctx.fillStyle="white",ctx.font="16px sans-serif",ctx.fillText("Press F5 to restart",c.width/2-100,c.height/2+30)}function rectsOverlap(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function loop(){if("gameOver"===gameState&&drawGameOver(),"playing"===gameState){requestAnimationFrame(loop),timer-=16,timer<=0&&(day=!day,timer=day?dayLength:nightLength),interactCooldown>0&&(interactCooldown-=16);const t=2;let e=0;craftingQueue||(keys.a&&(e-=t),keys.d&&(e+=t),keys.w&&player.onGround&&(player.vy=-8,player.onGround=!1));const l=blocks.concat(stones);player.vy+=gravity,player.y+=player.vy,player.onGround=!1;for(let t of blocks)player.x<t.x+t.w&&player.x+player.w>t.x&&player.y<t.y+t.h&&player.y+player.h>t.y&&player.vy>0&&(player.y=t.y-player.h,player.vy=0,player.onGround=!0);player.x+=e;for(const t of l)player.x<t.x+t.w&&player.x+player.w>t.x&&player.y<t.y+t.h&&player.y+player.h>t.y&&(e>0?player.x=t.x-player.w:e<0&&(player.x=t.x+t.w));player.vy+=gravity,player.y+=player.vy,player.onGround=!1;for(const t of l)player.x<t.x+t.w&&player.x+player.w>t.x&&player.y<t.y+t.h&&player.y+player.h>t.y&&(player.vy>0?(player.y=t.y-player.h,player.vy=0,player.onGround=!0):player.vy<0&&(player.y=t.y+t.h,player.vy=0));if(keys[" "]&&interactCooldown<=0){const t=12,e=()=>{interactCooldown=200};let l=!1;if(void 0!==stones){for(const e of stones)if(player.x+player.w>e.x-t&&player.x<e.x+e.w+t&&player.y+player.h>e.y-t&&player.y<e.y+e.h+t&&e.hp>0){e.hp--,e.hitCooldown=10,l=!0,e.hp<=0&&(console.log("added to inventory"),addToInventory("stone",3));break}stones=stones.filter(t=>t.hp>0)}if(!l){for(const e of trees)if(player.x+player.w>e.x-t&&player.x<e.x+e.w+t&&player.y+player.h>e.y-t&&player.y<e.y+e.h+t&&e.hp>0){e.hp--,l=!0,e.hp<=0&&(console.log("added to inventory"),addToInventory("wood",5));break}trees=trees.filter(t=>t.hp>0)}l&&e(),keys[" "]=!1}for(let t of stones)t.hitCooldown&&t.hitCooldown--;if(stones=stones.filter(t=>t.hp>0),!1===day){for(let t of traps)t.active&&cat.x<t.x+t.w&&cat.x+cat.w>t.x&&cat.y<t.y+t.h&&cat.y+cat.h>t.y&&(t.active=!1,cat.stunnedUntil=Date.now()+3e3);cat.stunnedUntil&&Date.now()<cat.stunnedUntil||(cat.x+=cat.speed),blinking?(blinkDuration-=30,blinkDuration<=0&&(blinking=!1,blinkCooldown=1500+2e3*Math.random())):(blinkCooldown-=10,blinkCooldown<=0&&(blinking=!0,blinkDuration=180)),player.x<cat.x+cat.w&&player.x+player.w>cat.x&&player.y<cat.y+cat.h&&player.y+player.h>cat.y&&(gameState="gameOver")}if(!0===day&&(blinking=!1,blinkDuration=0),camX=player.x-c.width/2,camX<0&&(camX=0),craftingQueue&&(craftingQueue.timeLeft-=1/60,craftingQueue.timeLeft<=0)){console.log("klar:",craftingQueue.recipe.name);let t=craftingQueue.recipe.name.toLowerCase();inventory[t]=(inventory[t]||0)+1,craftingQueue=null}drawBackground(),drawPlattform(),drawTrees(),drawCat(),drawPlayer(),drawTraps(),drawUI(),drawInventory(),drawCrafting(),drawCraftingProgress()}}c.addEventListener("mousemove",t=>{const e=c.getBoundingClientRect();mouse.x=t.clientX-e.left,mouse.y=t.clientY-e.top}),c.addEventListener("mousedown",t=>{if(!craftingOpen)return;const e=c.getBoundingClientRect(),l=t.clientX-e.left,a=t.clientY-e.top,i=50,n=(c.width-186)/2+10,r=(c.height-186)/2+10;craftingRecipes.forEach((t,e)=>{const c=e%3,o=Math.floor(e/3),y=n+58*c,f=r+58*o;l>y&&l<y+i&&a>f&&a<f+i&&(console.log("Klick pÃ¥:",t.name),craftingQueue||(console.log("vi hamnar i queue:"),craftingQueue={recipe:t,timeLeft:t.time},craftingOpen=!1))})}),loop();